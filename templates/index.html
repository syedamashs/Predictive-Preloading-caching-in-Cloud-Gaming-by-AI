<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Predictive Climate Game</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    body {
      background: linear-gradient(to bottom right, #e0f2fe, #f5f3ff);
      min-height: 100vh;
      padding: 2rem 1rem;
    }

    h2 { font-weight: bold; }

    /* Number boxes */
    .number-box {
      width: 60px;
      height: 60px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      border-radius: 12px;
      border: 2px solid #ddd;
      transition: all 0.2s;
    }
    .number-box:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25);
    }

    /* Prediction Card */
    .prediction-card {
      max-width: 360px;
      width: 100%;
      border-radius: 16px;
      padding: 1rem;
      background: linear-gradient(to right, #f3e8ff, #e0f2fe);
      border: 1px solid #ddd;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      margin-top: 10px;
      text-align: center;
    }

    .badge-sunny { background-color: #fde68a; color: #92400e; }
    .badge-rainy { background-color: #bfdbfe; color: #1e3a8a; }
    .badge-snowy { background-color: #cffafe; color: #0c4a6e; }

    /* Video player */
    .video-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
    }
    .video-container video {
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 480px;
      height: auto;
    }

    /* Preload status */
    .preload-status { font-size: 0.9rem; margin-top: 0.5rem; }

    /* Loading spinner */
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body class="container py-5">
  <h2 class="mb-4 text-center">üå¶Ô∏è Predictive Climate Game</h2>

  <!-- Numbers + Clear button -->
  <div class="d-flex flex-column align-items-center gap-3 mb-3">
    <h5>Enter Numbers</h5>
    <div class="d-flex gap-2 align-items-center">
      <input type="number" id="num1" class="number-box" maxlength="1" oninput="handleNumberInput()">
      <input type="number" id="num2" class="number-box" maxlength="1" oninput="handleNumberInput()">
      <input type="number" id="num3" class="number-box" maxlength="1" oninput="handleNumberInput()">
      <input type="number" id="num4" class="number-box" maxlength="1" oninput="handleNumberInput()">
      <button class="btn btn-secondary btn-sm" onclick="clearNumbers()">Clear</button>
    </div>

    <!-- Prediction Card BELOW numbers -->
    <div id="predictionCard" class="prediction-card" style="display:none;">
      <span id="predictionBadge" class="badge rounded-pill mb-2"></span>
      <p id="prediction" class="mb-1"></p>
      <p id="preloadStatus" class="preload-status"></p>
    </div>
  </div>

  <!-- Dropdown + Save/Stream -->
  <div class="d-flex justify-content-center align-items-center gap-2 mb-4 flex-wrap">
    <select id="climate" class="form-select w-auto">
      <option value="">Select Actual Climate</option>
      <option value="sunny">‚òÄÔ∏è Sunny</option>
      <option value="rainy">üåßÔ∏è Rainy</option>
      <option value="snowy">‚ùÑÔ∏è Snowy</option>
    </select>
    <button class="btn btn-success" onclick="saveClimate()">Save & Stream</button>
  </div>

  <!-- Video Player -->
  <div class="video-container mb-5">
    <h5 id="videoTitle" class="mb-2"></h5>
    <video id="videoPlayer" controls style="display:none;"></video>
  </div>

  <script>
    const userId = "u1"; 
    let numbers = [];
    let preloadedUrl = null;

    async function handleNumberInput() {
      numbers = [];
      for (let i = 1; i <= 4; i++) {
        const val = document.getElementById("num" + i).value;
        if (val) numbers.push(parseInt(val));
      }

      const predictionCard = document.getElementById("predictionCard");
      const badge = document.getElementById("predictionBadge");
      const text = document.getElementById("prediction");
      const preloadStatus = document.getElementById("preloadStatus");

      if (numbers.length === 0) {
        text.innerText = "Enter numbers...";
        predictionCard.style.display = "none";
        return;
      }

      const res = await fetch("/game", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId, numbers })
      });

      const data = await res.json();

      if (data.prediction === "Unknown" || data.matchScore === 0) {
        text.innerText = "No prediction yet...";
        preloadStatus.innerText = "";
        predictionCard.style.display = "none";
      } else {
        predictionCard.style.display = "block";
        text.innerText = `Prediction: ${data.prediction} | Based On: ${data.basedOn} | Match Score: ${data.matchScore}`;
        badge.className = "badge rounded-pill mb-2";
        if (data.prediction.toLowerCase() === "sunny") badge.classList.add("badge-sunny");
        else if (data.prediction.toLowerCase() === "rainy") badge.classList.add("badge-rainy");
        else badge.classList.add("badge-snowy");
        badge.innerText = data.prediction;

        // Preload video UI
        preloadStatus.innerHTML = `<i class="bi bi-arrow-repeat animate-spin"></i> Preloading ${data.prediction}.mp4...`;
        preloadVideo(data.prediction);
      }
    }

    function clearNumbers() {
      // Clear numbers
      for (let i = 1; i <= 4; i++) document.getElementById("num" + i).value = '';
      numbers = [];

      // Hide prediction card
      document.getElementById("predictionCard").style.display = "none";

      // Hide video player
      const video = document.getElementById("videoPlayer");
      video.style.display = "none";
      video.src = '';
      preloadedUrl = null;

      // Clear video title
      document.getElementById("videoTitle").innerText = '';
    }

    async function preloadVideo(climate) {
      const preloadStatus = document.getElementById("preloadStatus");
      try {
        const res = await fetch(`/static/videos/${climate}.mp4`);
        const blob = await res.blob();
        preloadedUrl = URL.createObjectURL(blob);
        preloadStatus.innerHTML = `‚úÖ ${climate}.mp4 fully preloaded!`;
        const video = document.getElementById("videoPlayer");
        video.src = preloadedUrl;
        video.style.display = "block";
      } catch (err) {
        preloadStatus.innerText = `‚ùå Failed to preload ${climate}.mp4`;
      }
    }

    async function saveClimate() {
      const climate = document.getElementById("climate").value;
      if (!climate) { alert("Please choose a climate!"); return; }

      const res = await fetch("/game", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId, numbers, climate })
      });

      if (res.ok) {
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const video = document.getElementById("videoPlayer");
        video.src = url;
        video.style.display = "block";
        video.play();
        document.getElementById("videoTitle").innerText = `Now Playing: ${climate} Climate`;
      }
    }
  </script>
</body>
</html>
